---
title: "GASã‚’claspï¼ˆCLIãƒ„ãƒ¼ãƒ«ï¼‰+ TypeScriptã§ãƒ­ãƒ¼ã‚«ãƒ«ã§é–‹ç™ºã™ã‚‹"
date: "2020-06-22T19::13.000Z"
updatedAt: ""
template: "post"
draft: false
slug: "/posts/clasp-typescript"
category: "Google Apps Script"
tags:
    - "Google Apps Script"
    - "TypeScript"
description: ""
socialImage: "/media/2020/6/22/2020_06_22__0.png"
---

![GASã®ç”»é¢](/media/2020/6/22/2020_06_22__0.png)

## Google Apps Scriptã‚’TypeScriptã§ãƒ­ãƒ¼ã‚«ãƒ«ã§é–‹ç™ºã™ã‚‹
Google Apps Scriptï¼ˆä»¥ä¸‹ã€GASï¼‰ã¯GoogleãŒé–‹ç™ºã—ãŸã‚µãƒ¼ãƒãƒ¬ã‚¹ãªé–¢æ•°ã®å®Ÿè¡Œç’°å¢ƒã§ã™ã€‚**GASã¯Googleã®å„ç¨®ã‚µãƒ¼ãƒ“ã‚¹ã¨é€£æºã—ã¦ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œã§ãã‚‹ãŸã‚ã€æ¥­å‹™ã‚„ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãƒ¯ãƒ¼ã‚¯ã®è‡ªå‹•åŒ–ã«æœ€é©ã§ã™ã€‚**

ã“ã®ãƒ–ãƒ­ã‚°ã§ã‚‚GASã‚’ä½¿ã£ãŸãƒãƒƒã‚¯ã‚’ç´¹ä»‹ã—ã¦ãã¾ã—ãŸã€‚

- [Google Apps Scirptã‹ã‚‰Slackã¨LINEã¨é€£æºã™ã‚‹botã‚’ä½œã‚‹æ‰‹é †ã‚’ç´¹ä»‹ã—ã¾ã™](/posts/google-apps-script-api-templates)
- [Gmailã®æ–°ç€ãƒ¡ãƒ¼ãƒ«ã‚’LINEã«è»¢é€ã™ã‚‹ by Google Apps Script](/posts/gmail-to-line)
- [GASã§è­°äº‹éŒ²ã®ãƒ†ãƒ³ãƒ—ãƒ¬ä½œæˆã¨å‘¨çŸ¥ã‚’è‡ªå‹•åŒ–ã™ã‚‹](/posts/copy-google-document-weekly)
- [ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¨UMLã§è¨ºæ–­ãƒãƒ£ãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹Google Apps Scriptã®ã‚³ãƒ¼ãƒ‰ã‚’ç´¹ä»‹ã—ã¾ã™](/posts/make-uml-flowchart-from-spreadsheet-by-google-apps-script)

**ã“ã®è¨˜äº‹ã§ã¯ã€[clasp](https://github.com/google/clasp/)ã¨ã„ã†Googleè£½ã®CLIãƒ„ãƒ¼ãƒ«ã‚’å°å…¥ã—ã€ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§TypeScriptã‚’ä½¿ã£ã¦GASã‚’é–‹ç™ºã™ã‚‹æ–¹æ³•ã‚’ã”ç´¹ä»‹ã—ã¾ã™ã€‚**

ã¾ãšclaspã‚’å°å…¥ã—ã€TypeScriptã‚’æ›¸ã„ã¦GASä¸Šã§Hello Worldã—ã¾ã™ã€‚æ¬¡ã«ã€ã‚ˆã‚Šå®Ÿè·µçš„ãªä½¿ã„æ–¹ã¨ã—ã¦Gmailã‚’LINEã«è»¢é€ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’TypeScriptã§å®Ÿè£…ã—ã¾ã™ã€‚

## GASç”¨ã®CLIãƒ„ãƒ¼ãƒ«claspã‚’å°å…¥ã™ã‚‹
claspã®å°å…¥æ–¹æ³•ã¯`$ npm i @google/clasp -g`ã‚’å®Ÿè¡Œã™ã‚‹ã ã‘ã§ã™ã€‚

```s
$ npm i @google/clasp -g

+ @google/clasp@2.3.0
added 160 packages from 92 contributors in 13.169s
```

ã“ã‚Œã§`clasp`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

```s
$ clasp
Usage: clasp <command> [options]

clasp - The Apps Script CLI

Options:
  -v, --version
  -h, --help                                  output usage information

Commands:
  login [options]                             Log in to script.google.com
  logout                                      Log out
  create [options]                            Create a script
  ...
```

æ¬¡ã«Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½¿ã£ã¦ãƒ­ã‚°ã‚¤ãƒ³ã‚’ã—ã¾ã™ã€‚ã‚³ãƒãƒ³ãƒ‰ã¯`$ clasp login`ã§ã™ã€‚

```s
$ clasp login

Warning: You seem to already be logged in *globally*. You have a ~/.clasprc.json
Logging in globally...
ğŸ”‘ Authorize clasp by visiting this url:
https://accounts.google.com/o/oauth2/v2/auth?access_type=xxx

Authorization successful.

Default credentials saved to: ~/.clasprc.json (/Users/Panda/.clasprc.json).
```

**ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨æ–°ã—ããƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¿ãƒ–ãŒé–‹ãã¾ã™ã€‚ãã“ã§ã€ä»Šå›GASã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç®¡ç†ã—ãŸã„Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’é¸æŠã—ã¾ã—ã‚‡ã†ã€‚**

ãƒ­ã‚°ã‚¤ãƒ³ãŒã§ããŸã‚‰ã‚¿ãƒ–ã‚’é–‰ã˜ã¦ã‚‚OKã§ã™ã€‚

### claspã§TypeScriptã‚’æ‰±ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
claspã§TypeScriptã‚’æ‰±ãˆã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚[æ‰‹é †ã¯claspã®GitHubã‚’å‚è€ƒã«ã—ã¦ã„ã¾ã™ã€‚](https://github.com/google/clasp/blob/master/docs/typescript.md)

ã¾ãšã¯Hello Worldç”¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã€GASã®å‹æƒ…å ±ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```s
$ mkdir hello-world
$ cd hello-world
$ npm i -S @types/google-apps-script
+ @types/google-apps-script@1.0.14
added 1 package from 3 contributors and audited 1 package in 2.471s
found 0 vulnerabilities
```

æ¬¡ã«ã€`tsconfig.json`ã‚’ä½œæˆã—ã¾ã™ã€‚`tsconfig.json`ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã—ã¾ã™ã€‚

```json
{
  "compilerOptions": {
    "lib": ["es2019"],
    "experimentalDecorators": true
  }
}
```

**GASã¯JavaScriptã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚¨ãƒ³ã‚¸ãƒ³V8ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã®ã§ã€ES2019ã®æ©Ÿèƒ½ã‚’ä½¿ã†ã“ã¨ãŒã§ãã¾ã™**ï¼ˆä½†ã—ã€ES modulesã¯é™¤ãã¾ã™ï¼‰ã€‚

ã“ã‚Œã§TypeScriptã®GASãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã®æº–å‚™ãŒã§ãã¾ã—ãŸã€‚

### GASã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹
ã§ã¯ã€claspã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚`$ clasp create`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```s
$ clasp create --title "Hello World" --type standalone
\ Creating new script: Hello World...
Created new standalone script: https://script.google.com/d/XXXXXXXXXXXX/edit
Warning: files in subfolder are not accounted for unless you set a '.claspignore' file.
Cloned 1 file.
â””â”€ appsscript.json
```

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«`appsscript.json`ãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®TimeZoneã¯America/NewYorkãªã®ã§ã€Asia/Tokyoã«å¤‰æ›´ã—ã¾ã™ã€‚

```json
{
  "timeZone": "Asia/Tokyo",
  "dependencies": {
  },
  "exceptionLogging": "STACKDRIVER",
  "runtimeVersion": "V8"
}
```

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã§ãã¾ã—ãŸï¼ã§ã¯ã€Hello Worldã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã€GASã§å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

## [åŸºç¤ç·¨]TypeScript + GASã§Hello Worldã™ã‚‹
`hello.ts`ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¿°ã—ã¾ã™ã€‚

```ts
const greeter = (person: string) => {
  return `Hello, ${person}!`;
}

function testGreeter() {
  const user = 'Panda ğŸ¼';
  Logger.log(greeter(user));
}
```

GASã§TypeScriptã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã‚‚å‹•ãã¾ã›ã‚“ã€‚**ã—ã‹ã—ã€claspãŒTypeScriptã‚’JSã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦ãã‚Œã‚‹ã®ã§ã€é–‹ç™ºè€…ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§tsãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãã ã‘ã§ã„ã„ã®ã§ã™ï¼**

ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’GASã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã‚³ãƒãƒ³ãƒ‰ã¯`$ clasp push`ã§ã™ã€‚

```s
$ clasp push
â””â”€ appsscript.json
â””â”€ hello.ts
Pushed 2 files.
```

CLIã§ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸGASã®ç”»é¢ã‚’é–‹ãã“ã¨ã‚‚ã§ãã¾ã™ã€‚`$ clasp open`ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```s
$ clasp open
Opening script: https://script.google.com/d/XXXXXXXXXXXXXXXX/edit
```

ãƒ–ãƒ©ã‚¦ã‚¶ãŒç«‹ã¡ä¸ŠãŒã‚Šã€ã‚¿ãƒ–ãŒé–‹ãã¾ã—ãŸï¼

![GASã®ç”»é¢](/media/2020/6/22/2020_06_22__1.png)

TypeScriptã®ã‚³ãƒ¼ãƒ‰ã¯JavaScriptã®ã‚³ãƒ¼ãƒ‰ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚ã¾ãŸã€TypeScriptã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒ3.9.5ã§ã‚ã‚‹ã“ã¨ã‚‚ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰è¦‹ã¦å–ã‚Œã¾ã™ã­ã€‚

```js
// Compiled using ts2gas 3.6.2 (TypeScript 3.9.5)
var greeter = function (person) {
    return "Hello, " + person + "!";
};
function testGreeter() {
    var user = 'Panda ğŸ¼';
    Logger.log(greeter(user));
}
```

`testGreeter`ã‚’å®Ÿè¡Œã—ã¦ã€ãƒ­ã‚°ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

![GASã®ãƒ­ã‚°ã®ç”»é¢](/media/2020/6/22/2020_06_22__2.png)

`Hello, Panda ğŸ¼!`ã®ã¨å‡ºåŠ›ã•ã‚Œã¦ã„ã¾ã™ã€‚`testGreeter`ã‚’å®Ÿè¡Œã§ãã¾ã—ãŸï¼

## [å®Ÿè·µç·¨]Gmailã‚’LINEã«è»¢é€ã™ã‚‹GASã‚’æ›¸ã
**æ¬¡ã¯ã€ã‚ˆã‚Šå®Ÿè·µçš„ãªä¾‹ã‚’ç´¹ä»‹ã—ã¾ã—ã‚‡ã†ã€‚**

TypeScriptã§è¨˜è¿°ã—ã¦ã„ãã¾ã™ã€‚[ã€ŒGmailã®æ–°ç€ãƒ¡ãƒ¼ãƒ«ã‚’LINEã«è»¢é€ã™ã‚‹ by Google Apps Scriptã€](/posts/gmail-to-line)ã¨ã„ã†è¨˜äº‹ã§ç´¹ä»‹ã—ãŸã‚³ãƒ¼ãƒ‰ã‚’TypeScriptåŒ–ã—ã¦ã„ãã¾ã™ã€‚

```ts
const LINE_NOTIFY_TOKEN = PropertiesService
  .getScriptProperties()
  .getProperty('LINE_NOTIFY_TOKEN')
const ENDPOINT = 'https://notify-api.line.me/api/notify'

const FROM_ADDRESS = [''].join(' OR ')
const MINUTES_INTERVAL = 5

function main() {
  const notices = fetchNotices()

  if (notices.length === 0) {
    return
  }

  for (const notice of notices) {
    send(notice)
  }
}

function fetchNotices(): string[] {
  const now = Math.floor(new Date().getTime() / 1000)
  const intervalMinutesAgo = now - (60 * MINUTES_INTERVAL)
  const query = `(is:unread from:(${FROM_ADDRESS}) after:${intervalMinutesAgo})`

  const threads: GmailThread[] = GmailApp.search(query)

  if (threads.length === 0) {
    return []
  }

  const mails: GmailMessage[][] = GmailApp.getMessagesForThreads(threads)
  const notices: string[] = []

  for (const messages of mails) {
    const latestMessage: GmailMessage = messages.pop()
    const notice = `
--------------------------------------
ä»¶å: ${latestMessage.getSubject()}
å—ä¿¡æ—¥: ${latestMessage.getDate().toLocaleString()}
From: ${latestMessage.getFrom()}
--------------------------------------

${latestMessage.getPlainBody().slice(0, 350)}
`
    notices.push(notice)

    latestMessage.markRead()
  }

  return notices
}

function send(notice: string) {
  if (LINE_NOTIFY_TOKEN === null) {
    Logger.log('LINE_NOTIFY_TOKEN is not set.')
    return
  }

  const options: URLFetchRequestOptions = {
    'method': 'POST',
    'headers': {'Authorization': `Bearer ${LINE_NOTIFY_TOKEN}`},
    'payload': {'message': notice},
  }

  UrlFetchApp.fetch(ENDPOINT, options)
}
```

[JSã®ã‚³ãƒ¼ãƒ‰](/posts/gmail-to-line#ã‚³ãƒ¼ãƒ‰å…¨æ–‡ã‚’è¨˜è¼‰ã—ã¾ã™)ã¨æ¯”è¼ƒã™ã‚‹ã¨ã€`getMessagesForThreads`ã®è¿”ã‚Šå€¤ãŒå¤šæ¬¡å…ƒé…åˆ—ã«ãªã£ã¦ã„ã‚‹ã“ã¨ãŒæ˜ç¢ºã«æ„è­˜ã§ãã‚‹ã®ãŒã¨ã¦ã‚‚ã„ã„ã§ã™ã­ã€‚

![GASã®GmailAppã®å‹å®šç¾©](/media/2020/6/22/2020_06_22__3.png)

ã¾ãŸã€å‹å®šç¾©ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã§`getProperty`ã§ã‚­ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯nullã‚’è¿”ã™ã“ã¨ã‚’çŸ¥ã‚ŒãŸã‚Šã€fetchã®optionsã®å‹ã‚’`URLFetchRequestOptions`ã§ç¸›ã‚Œã‚‹ã“ã¨ã§ã€å®Ÿè¡Œæ™‚ã«ç™ºç”Ÿã™ã‚‹ãƒã‚°ã‚’æœªç„¶ã«é˜²ãã“ã¨ãŒã§ãã¾ã—ãŸã€‚

ãªãŠã€ä»Šå›å‚è€ƒã«ã—ãŸå‹å®šç¾©ã‚’æŠœç²‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```ts
interface Properties {
  getProperty(key: string): string | null;
}

interface GmailApp {
  search(query: string): GmailThread[];
  getMessagesForThreads(threads: GmailThread[]): GmailMessage[][];
}

interface GmailMessage {
  getSubject(): string;
  getDate(): Base.Date;
  getFrom(): string;
  getPlainBody(): string;
  markRead(): GmailMessage;
}
interface UrlFetchApp {
  fetch(url: string, params: URLFetchRequestOptions): HTTPResponse;
}

interface HttpHeaders {
  [key: string]: string;
}
type HttpMethod = 'get' | 'delete' | 'patch' | 'post' | 'put';
type Payload = string | { [key: string]: any } | Base.Blob;
```

## GASã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§TypeScriptã§é–‹ç™ºã™ã‚‹ãƒ¡ãƒªãƒƒãƒˆ
GASã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§æ›¸ãã“ã¨ãŒã§ãã‚‹ã“ã¨ã¯å¤§ããªãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚

- GASã«å‹æ³¨é‡ˆãŒã¤ãã“ã¨ã§ã€ãƒã‚°ã‚’ç”Ÿã¿ã«ãããªã‚‹
- å¥½ããªã‚¨ãƒ‡ã‚£ã‚¿ã‚’ä½¿ã†ã“ã¨ãŒã§ãã‚‹
- å‹å®šç¾©ã«ã‚¸ãƒ£ãƒ³ãƒ—ã—ã¦ã€å¼•æ•°ã‚„è¿”ã‚Šå€¤ã®å‹ã‚’ãƒã‚§ãƒƒã‚¯ã§ãã‚‹

**ç‰¹ã«IDEã‹ã‚‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚­ãƒ¼ã‚’æŠ¼ã™ã ã‘ã§å‹å®šç¾©ã«é£›ã¹ã‚‹ã®ã§ã€è¿”ã‚Šå€¤ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«logã‚’åãå‡ºã—ãŸã‚Šå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ¢ã™å¿…è¦ãŒç„¡ããªã‚Šã¾ã™ã€‚**

ã“ã®ãŸã‚ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’çµ„ã‚€ã‚¹ãƒ”ãƒ¼ãƒ‰ãŒTSãŒãªã„å ´åˆã¨æ¯”ã¹ã¦çˆ†é€Ÿã§ã™ã€‚**å‹å®šç¾©ã¯GASã‚’æ›¸ãã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’ä¸Šã’ã‚‹ã‚¢ã‚¯ã‚»ãƒ«ã¨ã„ã£ã¦ã‚‚éè¨€ã§ã¯ãªã„ã§ã—ã‚‡ã†ã€‚**

## ã¾ã¨ã‚
ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãŒã‚ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã‚„TDDã§ã‚‚ãªã„é™ã‚Šã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒ‡ãƒãƒƒã‚°æ–¹æ³•ã¯ã€Œå®Ÿè¡Œ â†’ ãƒ­ã‚°ç¢ºèª â†’ ä¿®æ­£ã€ãŒé€šå¸¸ã®æµã‚Œã§ã™ã€‚

ã—ã‹ã—ã€TypeScriptãŒå‹ã§ç¸›ã£ã¦ãã‚Œã‚‹ãŠã‹ã’ã§ã€Œå®Ÿè¡Œ â†’ ãƒ­ã‚°ç¢ºèªã€ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ«ãƒ¼ãƒ—ã‚’å›ã™å›æ•°ã¯æ ¼æ®µã«æ¸›ã‚Šã¾ã—ãŸã€‚

TypeScirptã®ç´ æ™´ã‚‰ã—ã„é–‹ç™ºä½“é¨“ã‚’GASã§ã‚‚é–‹ç™ºã§ã‚‚äº«å—ã§ãã‚‹ã®ã¯å¬‰ã—ã„ã“ã¨ã§ã™ã€‚claspã‚’é–‹ç™ºã—ã€TypeScriptã«å¯¾å¿œã•ã›ã¦ãã‚ŒãŸGoogleã®ãƒãƒ¼ãƒ ã«æ„Ÿè¬ã§ã™ï¼
