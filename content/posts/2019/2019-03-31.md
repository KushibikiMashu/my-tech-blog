---
title: "GAS + TypeScriptã§LINEã«é€šçŸ¥ã‚’é€ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™"
date: "2019-03-31T20:44:00.000Z"
updatedAt: "2020-07-19T14:41:09.000Z"
template: "post"
draft: false
slug: "/posts/call-line-notify-api-from-google-apps-script-by-clasp-with-typescript"
category: "Google Apps Script"
tags:
    - "Google Apps Script"
    - "LINE"
    - "clasp"
    - "TypeScript"
description: "GASã‚’TypeScriptã§æ›¸ã‘ã‚‹Claspã¨ã„ã†ãƒ„ãƒ¼ãƒ«ã®ç´¹ä»‹ã§ã™ã€‚"
socialImage: "/media/2019/3/2019-03-31__a.png"
---

## æ™‚ä»£ã¯ã‚µãƒ¼ãƒãƒ¬ã‚¹ã¸

ä»¥å‰ã€PHPã§LINE Notifyã®APIã‚’å©ããƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’æ›¸ãã¾ã—ãŸã€‚

é–¢é€£è¨˜äº‹: [GASã‚’claspï¼ˆCLIãƒ„ãƒ¼ãƒ«ï¼‰+ TypeScriptã§ãƒ­ãƒ¼ã‚«ãƒ«ã§é–‹ç™ºã™ã‚‹](/posts/clasp-typescript)

ã“ã®æ™‚ã¯PHPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ¬ãƒ³ã‚¿ãƒ«ã‚µãƒ¼ãƒãƒ¼ã«ç½®ãã€cronã§å®šæœŸå®Ÿè¡Œã•ã›ã¦ã„ã¾ã—ãŸã€‚

ã—ã‹ã—ã€æ™‚ä»£ã¯ã‚µãƒ¼ãƒãƒ¬ã‚¹ã§ã™ã€‚APIã‚’å©ãã ã‘ãªã‚‰Google Apps Scriptã‚„AWS Lambdaã¨ã„ã£ãŸFaaSã§å®Ÿç¾ã§ãã¾ã™ã€‚

ä»Šå›ã¯Typescriptã‚’å­¦ã³ãŸã‹ã£ãŸã®ã§ã€[clasp](https://github.com/google/clasp)ã‚’ä½¿ã£ã¦Google Apps Scriptã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚claspã‚’ä½¿ã†ã¨ã€webpackãªã©ã®è¨­å®šãŒä¸è¦ã«ãªã‚Šã€æ°—è»½ã«Typescriptã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚

## claspã®ä¸»ãªã‚³ãƒãƒ³ãƒ‰

é–‹ç™ºä¸­ã«ä½¿ã†ä¸»ãªclaspã‚³ãƒãƒ³ãƒ‰ã¯ä»¥ä¸‹ã§ã™ã€‚

```
$ clasp login  // script.google.comã«ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹
$ clasp create // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹
$ clasp push   // tsãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã¨GASã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
$ clasp open   // è©²å½“ã®GASã®ãƒšãƒ¼ã‚¸ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã
$ clasp deploy [Version] [Description] // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç®¡ç†ã§ãã‚‹
```

claspã«ã¤ã„ã¦ã¯ä¸‹è¨˜ã®è¨˜äº‹ãŒè©³ã—ã„ã§ã™ã€‚

[GAS ã®Googleè¬¹è£½CLIãƒ„ãƒ¼ãƒ« clasp](https://qiita.com/HeRo/items/4e65dcc82783b2766c03)

## ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã

```ts
const properties = PropertiesService.getScriptProperties()
// APIãƒˆãƒ¼ã‚¯ãƒ³ã¯ä¸‹è¨˜ãƒšãƒ¼ã‚¸ã‹ã‚‰ç™ºè¡Œã™ã‚‹ã€‚é€šçŸ¥ã‚’æŠ•ç¨¿ã™ã‚‹ãƒãƒ£ãƒ³ãƒãƒ«ã‚’é¸æŠã™ã‚Œã°ãƒˆãƒ¼ã‚¯ãƒ³ãŒç™ºè¡Œã•ã‚Œã‚‹ã€‚
// https://notify-bot.line.me/ja/
const TOKEN = properties.getProperty('LINE_NOTIFY_TOKEN')
const FROM = new Date(properties.getProperty('FROM'))
const ENDPOINT = 'https://notify-api.line.me/api/notify'
const MILLISECONDS_OF_DAY = 86400000
const DAYS_OF_YEAR = 365
// ã‚¹ã‚¿ãƒ³ãƒ—ã®IDã¯ä¸‹è¨˜ã‚¢ãƒ‰ãƒ¬ã‚¹ã«è¨˜è¼‰
// https://devdocs.line.me/files/sticker_list.pdf
const STAMPS = [
    608, // ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆãƒœãƒƒã‚¯ã‚¹
    301, // ã‚«ã‚¯ãƒ†ãƒ«
    269, // ãƒãƒ¼ãƒˆ
    268, // è™¹
]

function getHeaders(): { [key: string]: string } {
    return {
        "Content-Type": "application/x-www-form-urlencoded",
        "Authorization": `Bearer ${TOKEN}`
    }
}

function getStampNumber(): number {
    const length = STAMPS.length
    const random = getRandomInt(length)
    return STAMPS[random]
}

function getRandomInt(max: number): number {
    return Math.floor(Math.random() * Math.floor(max));
}

function getPayload(): string {
    const params = {
        'message': getMessage(),
        'stickerPackageId': 4,
        'stickerId': getStampNumber()
    }

    let body = [];
    Object.keys(params).map(key => {
        body.push(key + '=' + encodeURI(params[key]));
    })
    return body.join("&")
}

function getMessage(): string {
    const now = new Date()
    const diff = getDayDiff(now)
    const [years, days] = getYearsAndDays(diff)
    return createMessage(diff, years, days)
}

function getDayDiff(now: Date): number {
    const diff = (now - FROM) / MILLISECONDS_OF_DAY
    return Math.floor(diff)
}

function getYearsAndDays(diff: number): Array<number> {
    const years = Math.floor(diff / DAYS_OF_YEAR)
    const days = diff - DAYS_OF_YEAR * years
    return [years, days]
}

function createMessage(diff: number, years: number, days: number): string {
    return `
ğŸ‰ãŠã‚ã§ã¨ã†ğŸ‰
äºŒäººãŒä»˜ãåˆã£ã¦ã‹ã‚‰
${diff}æ—¥ãŒçµŒã¡ã¾ã—ãŸğŸ˜
ä»Šæ—¥ã§${years}å¹´ã¨${days}æ—¥ã§ã™ğŸ’•
ã“ã‚Œã‹ã‚‰ã‚‚ã‚ˆã‚ã—ãã­ğŸ˜˜`
}

function send(): void {
    const options = {
        "method": "POST",
        "headers": getHeaders(),
        "payload": getPayload(),
        "muteHttpExceptions": true
    }
    Logger.log(options);
    const res = UrlFetchApp.fetch(ENDPOINT, options);
    Logger.log(res.getContentText());
}
```

## GASã®ãƒ¡ãƒªãƒƒãƒˆ
APIã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã€Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã€ã«è¨˜è¿°ã§ãã‚‹ãŸã‚ã€èª¤ã£ã¦ãƒˆãƒ¼ã‚¯ãƒ³ãŒæµå‡ºã™ã‚‹ã“ã¨ã‚’é¿ã‘ã‚‰ã‚Œã‚‹ã€‚

![GASã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è¨­å®šç”»é¢](/media/2019/3/2019-03-31__1.png)

`PropertiesService.getScriptProperties().getProperty('KEYå')`ã§å€¤ã‚’å–å¾—ã™ã‚‹ã€‚`FROM`ã¯2019-04-01ã®ã‚ˆã†ã«`YYYY-MM-DD`ã§å®šç¾©ã™ã‚‹ã€‚

## claspã®ãƒ¡ãƒªãƒƒãƒˆ
- ES6ã®æ§‹æ–‡ãŒä½¿ãˆã‚‹
- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒ†ãƒ©ãƒ«ãŒä½¿ãˆã€æ–‡å­—åˆ—ã®é€£çµã‚’å¤šç”¨ã›ãšã«æ¸ˆã‚€
- Typescriptã‚’å­¦ã¶ã“ã¨ãŒã§ãã‚‹
    - å°å…¥æ–¹æ³•ã«ã¤ã„ã¦ã¯claspã®[TypeScriptã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://github.com/google/clasp/blob/master/docs/typescript.md)ã‚’å‚ç…§
- GitHubã§ã®ã‚³ãƒ¼ãƒ‰ã®ç®¡ç†ãŒæ¥½
    - ã‚‚ã—`clasp push`ãŒãªã‘ã‚Œã°ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§æ›¸ã„ãŸã‚³ãƒ¼ãƒ‰ã‚’GASã«ã‚³ãƒ”ãƒšã™ã‚‹ãŸã‚ç…©é›‘
- ä»Šå›ã¯ä¸ä½¿ç”¨ã ãŒã€Classæ§‹æ–‡ã‚‚ä½¿ãˆã‚‹

## çµæœ
PHPã‹ã‚‰GAS+Typescriptã¸è¼‰ã›æ›¿ãˆãŒã§ãã¾ã—ãŸï¼

![GASã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è¨­å®šç”»é¢](/media/2019/3/2019-03-31__0.png)
